<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI Website Audit Tool</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>
<body style="background-color: #080808; margin: 0; padding: 0;">
  <div id="root"></div>

  <script type="text/babel">
    const { useState } = React;
    
    // Lucide Icons as React components
    const Search = ({ className }) => (
      <svg className={className} width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <circle cx="11" cy="11" r="8"></circle>
        <path d="m21 21-4.35-4.35"></path>
      </svg>
    );

    const CheckSquare = ({ className }) => (
      <svg className={className} width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <polyline points="9 11 12 14 22 4"></polyline>
        <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path>
      </svg>
    );

    const Square = ({ className }) => (
      <svg className={className} width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
      </svg>
    );

    const Loader2 = ({ className }) => (
      <svg className={className} width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <path d="M21 12a9 9 0 1 1-6.219-8.56"></path>
      </svg>
    );

    const AlertCircle = ({ className }) => (
      <svg className={className} width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <circle cx="12" cy="12" r="10"></circle>
        <line x1="12" y1="8" x2="12" y2="12"></line>
        <line x1="12" y1="16" x2="12.01" y2="16"></line>
      </svg>
    );

    const Download = ({ className }) => (
      <svg className={className} width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
        <polyline points="7 10 12 15 17 10"></polyline>
        <line x1="12" y1="15" x2="12" y2="3"></line>
      </svg>
    );

    const WebsiteAuditTool = () => {
      const [url, setUrl] = useState('');
      const [isAnalyzing, setIsAnalyzing] = useState(false);
      const [auditReport, setAuditReport] = useState(null);
      const [screenshot, setScreenshot] = useState(null);
      const [elementScreenshots, setElementScreenshots] = useState(null);
      const [error, setError] = useState('');
      const [selectedModel, setSelectedModel] = useState('gemini-2.0-flash');
      const [backendUrl, setBackendUrl] = useState('https://sd-ai-audit.onrender.com');

      // Store default prompts for reset functionality
      const getDefaultAuditOptions = () => ({
        userJourneys: {
          title: 'Mapping of the existing user journeys',
          items: {
            criticalJourneys: {
              label: 'Identify the most critical user journeys (based on business goals and user frequency)',
              checked: true,
              prompt: 'Based on the main CTAs on the website, determine business goals. For example, if the CTA is Book a demo consider this as a business goal. If there\'s a form for the website visitor to populate, consider that action as another business goal',
            },
            userTypes: {
              label: 'Consider different user types',
              checked: true,
              prompt: 'Based on the content on the website, make a conclusion who is the target persona. If this can\'t be concluded, state in your answer that this is your assumption based on the content.',
            },
            painPoints: {
              label: 'Pain Points: Friction, confusion, unnecessary steps, dead ends',
              checked: true,
              prompt: 'Discover opportunities for improvement. Look into friction, confusing content, unnecessary steps, dead ends and similar things that could prevent the website visitor to continue user journey',
            },
            happyPath: {
              label: 'Map both happy path and alternative/edge case scenarios',
              checked: true,
              prompt: 'This relates to the previous point Identify the most critical user journeys. It might not be relevant for the presentational websites, but in the cases when there\'s a contact form, register flow, scheduling meeting flow etc it\'s important to observe what if something opposit to the happy flow happens.',
            },
            dropOffRisks: {
              label: 'Drop-off Risks: Where users are likely to abandon the flow',
              checked: true,
              prompt: 'Try to find obvious reasons for the user to abandon the flow (for example: too complex forms that require a lot of info to be provided from the user, payment required at certain step etc)',
            },
            cognitiveLoad: {
              label: 'Cognitive Load: Mental effort required at each step',
              checked: true,
              prompt: 'In this aspect of the audit observe content primary and see how difficult for the user is to understand key messages.',
            },
            errorHandling: {
              label: 'Error Handling: What happens when things go wrong',
              checked: true,
              prompt: 'This might not be relevant for presentational websites, but in the cases when there\'s a contact form, register flow, scheduling meeting flow etc it\'s important to observe how errors are handeled.',
            },
            efficiency: {
              label: 'Efficiency: Time and effort required to complete tasks',
              checked: true,
              prompt: 'In this aspect of the audit observe content primary and see how difficult for the user to take actions to go throuh the flow and achieve business goals.',
            },
            userEmotions: {
              label: 'User emotions and frustrations at different stages',
              checked: true,
              prompt: 'Observe user personas and user joerneys they could take in the context of conversion funnel Awareness → Interest → Consideration → Action and point out where are opportunities for improvements in order to convert',
            },
            mobileVsDesktop: {
              label: 'Mobile vs. desktop experience differences',
              checked: true,
              prompt: 'Go through the webiste on desktop and mobile and point out main areas for improvement considering the points above',
            },
          },
        },
        userExperience: {
          title: 'User Experience',
          items: {
            navigation: {
              label: 'Navigation & Information Architecture',
              checked: true,
              prompt: '',
            },
            ctaPlacement: {
              label: 'Call-to-action placement and clarity',
              checked: true,
              prompt: '',
            },
            hoverStates: {
              label: 'Hover states and interactive elements behaviour',
              checked: true,
              prompt: '',
            },
            interactions: {
              label: 'Interactions / animations assessment',
              checked: true,
              prompt: '',
            },
            touchTargets: {
              label: 'Touch target sizing for mobile users',
              checked: true,
              prompt: '',
            },
            conversionPaths: {
              label: 'Primary conversion paths (contact, purchase, signup)',
              checked: true,
              prompt: '',
            },
            trustElements: {
              label: 'Trust & Credibility Elements',
              checked: true,
              prompt: '',
            },
            loadingStates: {
              label: 'Loading states and progress indicators',
              checked: true,
              prompt: '',
            },
            filterSorting: {
              label: 'Filter and sorting patterns',
              checked: true,
              prompt: '',
            },
          },
        },
        contentAssessment: {
          title: 'Content Assessment',
          items: {
            messageClarity: {
              label: 'Message clarity and value proposition communication',
              checked: true,
              prompt: '',
            },
            contentRelevance: {
              label: 'Content relevance to target audience and user needs',
              checked: true,
              prompt: '',
            },
            writingQuality: {
              label: 'Writing quality, grammar, and professional tone',
              checked: true,
              prompt: '',
            },
            imageQuality: {
              label: 'Image quality, relevance, and professional appearance',
              checked: true,
              prompt: '',
            },
            engagingOpening: {
              label: 'Engaging opening that hooks the reader immediately',
              checked: true,
              prompt: '',
            },
            logicalProgression: {
              label: 'Logical content progression that guides users through a journey',
              checked: true,
              prompt: '',
            },
            sufficientDetail: {
              label: 'Sufficient detail to answer user questions and build confidence',
              checked: true,
              prompt: '',
            },
            clearNextSteps: {
              label: 'Clear next steps or guidance on what to do after reading',
              checked: true,
              prompt: '',
            },
            personalTouches: {
              label: 'Personal touches that build trust and connection',
              checked: true,
              prompt: '',
            },
          },
        },
        accessibility: {
          title: 'Accessibility',
          items: {
            textContrast: {
              label: 'Text contrast (WCAG AA: 4.5:1 for normal text, 3:1 for large text)',
              checked: true,
              prompt: '',
            },
            nonTextContrast: {
              label: 'Non-text contrast (WCAG 2.1: 3:1 for UI components)',
              checked: true,
              prompt: '',
            },
            placeholderText: {
              label: 'Placeholder text (must meet contrast ratio)',
              checked: true,
              prompt: '',
            },
            focusIndicator: {
              label: 'Focus indicator (visible and clear, 3:1 contrast)',
              checked: true,
              prompt: '',
            },
            targetSize: {
              label: 'Target size (clickable areas at least 24x24px)',
              checked: true,
              prompt: '',
            },
            hoverOnlyInfo: {
              label: 'No hover-only info (must appear on focus/keyboard/tap)',
              checked: true,
              prompt: '',
            },
            reflow: {
              label: 'Reflow (content reflows to 320px width without horizontal scrolling)',
              checked: true,
              prompt: '',
            },
            zoom: {
              label: 'Zoom (UI scales up to 200% without breaking)',
              checked: true,
              prompt: '',
            },
            spacing: {
              label: 'Spacing (line height, letter spacing allow overrides)',
              checked: true,
              prompt: '',
            },
            colorAlone: {
              label: "Don't rely on color alone (status indicators need icon/label)",
              checked: true,
              prompt: '',
            },
            links: {
              label: 'Links (distinguishable by underline, bold, etc.)',
              checked: true,
              prompt: '',
            },
            states: {
              label: 'States (hover, active, disabled, focus visually distinct)',
              checked: true,
              prompt: '',
            },
            labels: {
              label: 'Labels (all form fields have visible, persistent labels)',
              checked: true,
              prompt: '',
            },
            errorMessages: {
              label: 'Error messages (clear, high-contrast, near relevant input)',
              checked: true,
              prompt: '',
            },
            touchTargets: {
              label: 'Touch targets (enough spacing on mobile to avoid accidental taps)',
              checked: true,
              prompt: '',
            },
          },
        },
      });

      // Define all audit categories and their checkboxes
      const [auditOptions, setAuditOptions] = useState(getDefaultAuditOptions());

      // Toggle individual checkbox
      const toggleCheckbox = (category, itemKey) => {
        setAuditOptions(prev => ({
          ...prev,
          [category]: {
            ...prev[category],
            items: {
              ...prev[category].items,
              [itemKey]: {
                ...prev[category].items[itemKey],
                checked: !prev[category].items[itemKey].checked,
              },
            },
          },
        }));
      };

      // Toggle all checkboxes in a category
      const toggleCategory = (category) => {
        const allChecked = Object.values(auditOptions[category].items).every(item => item.checked);
        const newCheckedState = !allChecked;

        setAuditOptions(prev => ({
          ...prev,
          [category]: {
            ...prev[category],
            items: Object.keys(prev[category].items).reduce((acc, key) => ({
              ...acc,
              [key]: {
                ...prev[category].items[key],
                checked: newCheckedState,
              },
            }), {}),
          },
        }));
      };

      // Update prompt for a specific item
      const updatePrompt = (category, itemKey, newPrompt) => {
        setAuditOptions(prev => ({
          ...prev,
          [category]: {
            ...prev[category],
            items: {
              ...prev[category].items,
              [itemKey]: {
                ...prev[category].items[itemKey],
                prompt: newPrompt,
              },
            },
          },
        }));
      };

      // Generate AI prompt based on selected options
      const generateAuditPrompt = (websiteContent) => {
        let prompt = `You are an expert UX/UI auditor and web accessibility specialist. Analyze the following website and provide a comprehensive audit report.

WEBSITE CONTENT:
${websiteContent}

AUDIT INSTRUCTIONS:
Analyze ONLY the following checked items and provide detailed findings, issues, and recommendations for each.

`;

        Object.entries(auditOptions).forEach(([categoryKey, category]) => {
          const checkedItems = Object.entries(category.items)
            .filter(([_, item]) => item.checked);
          
          if (checkedItems.length > 0) {
            prompt += `\n## ${category.title.toUpperCase()}\n`;
            checkedItems.forEach(([itemKey, item]) => {
              prompt += `\n✓ ${item.label}`;
              if (item.prompt && item.prompt.trim()) {
                prompt += `\n${item.prompt}`;
              }
              prompt += `\n`;
            });
          }
        });

        prompt += `\n\nFORMAT YOUR RESPONSE AS JSON:
{
  "categories": [
    {
      "title": "Category Name",
      "items": [
        {
          "label": "Item label",
          "status": "good" | "warning" | "critical",
          "findings": "Detailed description of what you found",
          "issues": ["List of specific issues if any"],
          "recommendations": ["List of specific recommendations"]
        }
      ]
    }
  ]
}

IMPORTANT: 
- Be specific and actionable in your recommendations
- Use "good" status for things done well, "warning" for minor issues, "critical" for serious problems
- Provide code examples or specific changes where relevant
- If you cannot assess something (like actual performance metrics), state that clearly
- Respond ONLY with valid JSON, no other text`;

        return prompt;
      };

      // Main analysis function
      const analyzeWebsite = async () => {
        if (!url) {
          setError('Please enter a website URL');
          return;
        }

        setIsAnalyzing(true);
        setError('');
        setAuditReport(null);
        setScreenshot(null);
        setElementScreenshots(null);

        try {
          console.log('Starting comprehensive audit...');
          console.log('URL:', url);
          console.log('Model:', selectedModel);
          console.log('Backend:', backendUrl);
          
          // Call backend API which handles website fetching and AI analysis
          const auditResponse = await fetch(`${backendUrl}/api/audit`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              url: url,
              auditOptions: auditOptions,
              model: selectedModel
            })
          });

          if (!auditResponse.ok) {
            // Clone response to read it multiple times if needed
            const errorResponse = auditResponse.clone();
            let errorData;
            try {
              errorData = await errorResponse.json();
            } catch (e) {
              try {
                const errorText = await auditResponse.text();
                errorData = { error: errorText };
              } catch (textError) {
                errorData = { error: `API request failed with status ${auditResponse.status}` };
              }
            }
            console.error('API Error:', errorData);
            throw new Error(errorData.error || `API request failed with status ${auditResponse.status}. Please check that the backend server is running.`);
          }

          const auditData = await auditResponse.json();
          
          // Handle response format: { success: true, report: {...} }
          let auditJson;
          if (auditData.report) {
            // New format - report is already parsed JSON object
            auditJson = auditData.report;
          } else if (auditData.content && auditData.content[0] && auditData.content[0].text) {
            // Old format - parse JSON from text
            let auditText = auditData.content[0].text;
            auditText = auditText.replace(/```json\s*/g, '').replace(/```\s*/g, '').trim();
            const jsonMatch = auditText.match(/\{[\s\S]*\}/);
            if (jsonMatch) {
              auditText = jsonMatch[0];
            }
            auditJson = JSON.parse(auditText);
          } else {
            throw new Error('Unexpected response format from server');
          }
          
          console.log('Parsed audit report:', auditJson);
          
          // Save screenshots if available
          if (auditData.screenshot) {
            setScreenshot(auditData.screenshot);
          } else {
            setScreenshot(null);
          }
          
          if (auditData.elementScreenshots) {
            setElementScreenshots(auditData.elementScreenshots);
          } else {
            setElementScreenshots(null);
          }
          
          // Validate the structure
          if (!auditJson.categories || !Array.isArray(auditJson.categories)) {
            throw new Error('Invalid audit report structure received');
          }
          
          setAuditReport(auditJson);

        } catch (err) {
          console.error('Analysis error:', err);
          let errorMessage = err.message;
          
          if (err.message.includes('JSON')) {
            errorMessage = 'Failed to parse audit report. The AI response was not in the expected format. Please try again.';
          } else if (err.message.includes('fetch') || err.message.includes('Failed to connect')) {
            errorMessage = 'Failed to connect to the backend server. Please make sure the backend is running on ' + backendUrl + '. Run "npm start" in the project directory.';
          } else if (err.message.includes('Failed to fetch website')) {
            errorMessage = 'Failed to fetch the website. Please check the URL and try again.';
          } else if (err.message.includes('504') || err.message.includes('Gateway Timeout') || err.message.includes('timeout')) {
            errorMessage = 'Request timed out. The analysis is taking too long. This might be due to a large website or slow response. Please try again or try a smaller website.';
          } else if (err.message.includes('body stream already read')) {
            errorMessage = 'Network error occurred. Please try again.';
          }
          
          setError(errorMessage);
        } finally {
          setIsAnalyzing(false);
        }
      };

      // Get status color
      const getStatusColor = (status) => {
        switch (status) {
          case 'good':
            return 'bg-green-100 text-green-800 border-green-300';
          case 'warning':
            return 'bg-yellow-100 text-yellow-800 border-yellow-300';
          case 'critical':
            return 'bg-red-100 text-red-800 border-red-300';
          case 'cannot_verify':
            return 'bg-gray-100 text-gray-800 border-gray-300';
          default:
            return 'bg-gray-100 text-gray-800 border-gray-300';
        }
      };

      // Get border color for status
      const getStatusBorderColor = (status) => {
        switch (status) {
          case 'good':
            return '#10b981'; // green
          case 'warning':
            return '#f59e0b'; // yellow
          case 'critical':
            return '#ef4444'; // red
          case 'cannot_verify':
            return '#6b7280'; // gray
          default:
            return '#6b7280'; // gray
        }
      };

      // Export audit report to PDF
      const exportToPDF = async () => {
        if (!auditReport) return;

        try {
          // Create a temporary container for PDF content
          const pdfContainer = document.createElement('div');
          pdfContainer.style.position = 'absolute';
          pdfContainer.style.left = '-9999px';
          pdfContainer.style.width = '210mm'; // A4 width
          pdfContainer.style.padding = '20mm';
          pdfContainer.style.backgroundColor = '#ffffff';
          pdfContainer.style.color = '#000000';
          pdfContainer.style.fontFamily = 'Arial, sans-serif';
          
          // Build PDF content
          let htmlContent = `
            <div style="margin-bottom: 30px;">
              <h1 style="font-size: 28px; font-weight: bold; margin-bottom: 10px; color: #1f2937;">AI Website Audit Report</h1>
              <p style="color: #6b7280; font-size: 14px;">Website: ${url}</p>
              <p style="color: #6b7280; font-size: 14px;">Generated: ${new Date().toLocaleString()}</p>
            </div>
          `;

          // Add screenshot to PDF if available
          if (screenshot) {
            htmlContent += `
              <div style="margin-bottom: 30px; page-break-inside: avoid;">
                <h2 style="font-size: 20px; font-weight: bold; margin-bottom: 15px; color: #1f2937;">Website Screenshot</h2>
                <div style="border: 1px solid #e5e7eb; border-radius: 8px; overflow: hidden; max-width: 100%;">
                  <img src="${screenshot}" alt="Website screenshot" style="width: 100%; height: auto; max-height: 400px; object-fit: contain; display: block;" />
                </div>
                <p style="color: #6b7280; font-size: 12px; margin-top: 8px;">Screenshot captured during audit</p>
              </div>
            `;
          }

          auditReport.categories.forEach((category, catIndex) => {
            htmlContent += `
              <div style="margin-bottom: 40px; page-break-inside: avoid;">
                <h2 style="font-size: 22px; font-weight: bold; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid #e5e7eb; color: #1f2937;">
                  ${category.title}
                </h2>
            `;

            category.items.forEach((item, itemIndex) => {
              // Check if findings indicate "cannot verify" for PDF
              const cannotVerify = item.findings && (
                item.findings.toLowerCase().includes('cannot verify') ||
                item.findings.toLowerCase().includes('cannot be verified') ||
                item.findings.toLowerCase().includes('may be dynamically loaded') ||
                item.findings.toLowerCase().includes('requires user interaction') ||
                item.findings.toLowerCase().includes('not available in static html')
              );
              
              // Determine actual status for PDF
              const actualStatus = cannotVerify ? 'cannot_verify' : item.status;
              const statusColor = actualStatus === 'good' ? '#10b981' : 
                                 actualStatus === 'warning' ? '#f59e0b' : 
                                 actualStatus === 'critical' ? '#ef4444' : '#6b7280';
              const statusText = actualStatus === 'cannot_verify' ? 'CANNOT VERIFY' : actualStatus.toUpperCase();

              htmlContent += `
                <div style="margin-bottom: 30px; padding-left: 15px; border-left: 4px solid ${statusColor}; page-break-inside: avoid;">
                  <div style="margin-bottom: 15px;">
                    <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 8px; color: #1f2937;">${item.label}</h3>
                    <span style="display: inline-block; padding: 4px 12px; border-radius: 12px; font-size: 11px; font-weight: 600; background-color: ${statusColor}20; color: ${statusColor}; border: 1px solid ${statusColor}40;">
                      ${statusText}
                    </span>
                  </div>
                  
                  <div style="margin-bottom: 15px;">
                    <p style="color: #374151; line-height: 1.6; font-size: 14px;">${item.findings}</p>
                  </div>
              `;

              if (item.issues && item.issues.length > 0) {
                htmlContent += `
                  <div style="margin-bottom: 15px;">
                    <p style="font-weight: 600; color: #ef4444; margin-bottom: 8px; font-size: 13px;">Issues Found:</p>
                    <ul style="margin-left: 20px; color: #374151; line-height: 1.8; font-size: 13px;">
                      ${item.issues.map(issue => `<li>${issue}</li>`).join('')}
                    </ul>
                  </div>
                `;
              }

              if (item.recommendations && item.recommendations.length > 0) {
                htmlContent += `
                  <div style="margin-bottom: 15px;">
                    <p style="font-weight: 600; color: #3b82f6; margin-bottom: 8px; font-size: 13px;">Recommendations:</p>
                    <ul style="margin-left: 20px; color: #374151; line-height: 1.8; font-size: 13px;">
                      ${item.recommendations.map(rec => `<li>${rec}</li>`).join('')}
                    </ul>
                  </div>
                `;
              }

              // Add screenshot to PDF if AI requested one
              if (item.screenshotRequest && elementScreenshots) {
                const requestLower = item.screenshotRequest.toLowerCase();
                let matchingScreenshot = null;
                
                if (requestLower.includes('form')) {
                  matchingScreenshot = elementScreenshots['form'] || elementScreenshots['[class*="form"]'];
                } else if (requestLower.includes('button') || requestLower.includes('cta')) {
                  matchingScreenshot = elementScreenshots['button'] || elementScreenshots['[class*="button"]'] || elementScreenshots['.cta'];
                } else if (requestLower.includes('nav') || requestLower.includes('menu')) {
                  matchingScreenshot = elementScreenshots['nav'];
                } else if (requestLower.includes('header')) {
                  matchingScreenshot = elementScreenshots['header'];
                }
                
                if (!matchingScreenshot && Object.keys(elementScreenshots).length > 0) {
                  matchingScreenshot = Object.values(elementScreenshots)[0];
                }
                
                if (matchingScreenshot) {
                  htmlContent += `
                    <div style="margin-bottom: 15px; margin-top: 15px;">
                      <p style="font-weight: 600; color: #9333ea; margin-bottom: 8px; font-size: 13px;">Relevant Screenshot:</p>
                      <p style="color: #6b7280; font-size: 11px; font-style: italic; margin-bottom: 8px;">${item.screenshotRequest}</p>
                      <div style="border: 1px solid #e5e7eb; border-radius: 8px; overflow: hidden; max-width: 400px;">
                        <img src="${matchingScreenshot}" alt="${item.screenshotRequest}" style="width: 100%; height: auto; max-height: 250px; object-fit: contain; display: block;" />
                      </div>
                    </div>
                  `;
                }
              }

              htmlContent += `</div>`;
            });

            htmlContent += `</div>`;
          });

          pdfContainer.innerHTML = htmlContent;
          document.body.appendChild(pdfContainer);

          // Use html2canvas to convert to image, then jsPDF to create PDF
          const canvas = await html2canvas(pdfContainer, {
            scale: 2,
            useCORS: true,
            logging: false,
            backgroundColor: '#ffffff'
          });

          const imgData = canvas.toDataURL('image/png');
          const { jsPDF } = window.jspdf;
          const pdf = new jsPDF('p', 'mm', 'a4');
          
          const imgWidth = 210; // A4 width in mm
          const pageHeight = 297; // A4 height in mm
          const imgHeight = (canvas.height * imgWidth) / canvas.width;
          let heightLeft = imgHeight;
          let position = 0;

          pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
          heightLeft -= pageHeight;

          while (heightLeft > 0) {
            position = heightLeft - imgHeight;
            pdf.addPage();
            pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
            heightLeft -= pageHeight;
          }

          // Generate filename
          const filename = `audit-report-${url.replace(/https?:\/\//, '').replace(/\//g, '-')}-${new Date().toISOString().split('T')[0]}.pdf`;
          pdf.save(filename);

          // Clean up
          document.body.removeChild(pdfContainer);
        } catch (error) {
          console.error('Error exporting PDF:', error);
          setError('Failed to export PDF. Please try again.');
        }
      };

      return (
        <div className="min-h-screen text-white p-4 md:p-8" style={{ backgroundColor: '#080808' }}>
          <div className="max-w-7xl mx-auto">
            {/* Header */}
            <div className="text-center mb-12">
              <h1 className="text-5xl md:text-6xl font-bold mb-4" style={{ color: '#ffffff' }}>
                AI Website Audit Tool
              </h1>
              <p className="text-lg" style={{ color: '#ffffff' }}>
                Comprehensive UX, Content, and Accessibility Analysis
              </p>
            </div>

            {/* URL Input Section */}
            <div className="rounded-2xl p-6 md:p-8 mb-8 shadow-2xl border" style={{ backgroundColor: 'rgba(255, 255, 255, 0.05)', borderColor: 'rgba(255, 255, 255, 0.1)' }}>
              <div className="mb-4">
                <label className="block text-sm font-medium mb-2 text-gray-300">
                  Website URL
                </label>
                <input
                  type="url"
                  value={url}
                  onChange={(e) => setUrl(e.target.value)}
                  placeholder="https://example.com"
                  className="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none text-white placeholder-gray-500"
                  style={{ backgroundColor: 'rgba(255, 255, 255, 0.05)', borderColor: 'rgba(255, 255, 255, 0.1)' }}
                  disabled={isAnalyzing}
                />
              </div>
              
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                  <label className="block text-sm font-medium mb-2 text-gray-300">
                    AI Model
                  </label>
                  <select
                    value={selectedModel}
                    onChange={(e) => setSelectedModel(e.target.value)}
                    disabled={isAnalyzing}
                    className="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none text-white"
                    style={{ backgroundColor: 'rgba(255, 255, 255, 0.05)', borderColor: 'rgba(255, 255, 255, 0.1)' }}
                  >
                    <option value="gemini-2.0-flash">Gemini 2.0 Flash (Recommended)</option>
                    <option value="gemini-1.5-flash">Gemini 1.5 Flash</option>
                  </select>
                </div>
                <div>
                  <label className="block text-sm font-medium mb-2 text-gray-300">
                    Backend URL
                  </label>
                  <input
                    type="text"
                    value={backendUrl}
                    onChange={(e) => setBackendUrl(e.target.value)}
                    placeholder="https://sd-ai-audit.onrender.com"
                    className="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none text-white placeholder-gray-500"
                  style={{ backgroundColor: 'rgba(255, 255, 255, 0.05)', borderColor: 'rgba(255, 255, 255, 0.1)' }}
                    disabled={isAnalyzing}
                  />
                </div>
              </div>
              
              <button
                onClick={analyzeWebsite}
                disabled={isAnalyzing || !url}
                className="w-full px-8 py-3 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-600 disabled:cursor-not-allowed rounded-lg font-medium transition-colors flex items-center justify-center gap-2 shadow-lg"
              >
                {isAnalyzing ? (
                  <>
                    <Loader2 className="w-5 h-5 animate-spin" />
                    Analyzing with Gemini...
                  </>
                ) : (
                  <>
                    <Search className="w-5 h-5" />
                    Start Audit
                  </>
                )}
              </button>
              
              {error && (
                <div className="mt-4 p-4 bg-red-900/50 border border-red-500 rounded-lg flex items-start gap-3">
                  <AlertCircle className="w-5 h-5 text-red-400 flex-shrink-0 mt-0.5" />
                  <p className="text-red-200">{error}</p>
                </div>
              )}
            </div>

            {/* Audit Options - Only show when not analyzing and no report */}
            {!isAnalyzing && !auditReport && (
              <div className="space-y-6 mb-8">
                <h2 className="text-2xl font-bold mb-4">Select Audit Criteria</h2>
                <p className="text-gray-400 mb-6">
                  All items are checked by default. Uncheck any items you don't want to analyze.
                </p>

                {Object.entries(auditOptions).map(([categoryKey, category]) => {
                  const checkedCount = Object.values(category.items).filter(item => item.checked).length;
                  const totalCount = Object.values(category.items).length;
                  const allChecked = checkedCount === totalCount;

                  return (
                    <div key={categoryKey} className="rounded-xl p-6 border" style={{ backgroundColor: 'rgba(255, 255, 255, 0.05)', borderColor: 'rgba(255, 255, 255, 0.1)' }}>
                      <div 
                        className="flex items-center gap-3 mb-4 cursor-pointer hover:bg-gray-700/50 p-2 rounded-lg transition-colors"
                        onClick={() => toggleCategory(categoryKey)}
                      >
                        {allChecked ? (
                          <CheckSquare className="w-6 h-6 text-blue-400 flex-shrink-0" />
                        ) : (
                          <Square className="w-6 h-6 text-gray-500 flex-shrink-0" />
                        )}
                        <div className="flex-1">
                          <h3 className="text-xl font-semibold">{category.title}</h3>
                          <p className="text-sm text-gray-400">{checkedCount} of {totalCount} selected</p>
                        </div>
                      </div>

                      <div className="space-y-3 pl-9">
                        {Object.entries(category.items).map(([itemKey, item]) => (
                          <div key={itemKey} className="space-y-2">
                            <div
                              className="flex items-start gap-3 cursor-pointer p-2 rounded-lg transition-colors hover:bg-white/10"
                              onClick={() => toggleCheckbox(categoryKey, itemKey)}
                            >
                              {item.checked ? (
                                <CheckSquare className="w-5 h-5 text-blue-400 flex-shrink-0 mt-0.5" />
                              ) : (
                                <Square className="w-5 h-5 text-gray-400 flex-shrink-0 mt-0.5" />
                              )}
                              <span className="text-gray-200 text-sm leading-relaxed">
                                {item.label}
                              </span>
                            </div>
                            {item.checked && (
                              <div className="ml-8">
                                <textarea
                                  value={item.prompt || ''}
                                  onChange={(e) => updatePrompt(categoryKey, itemKey, e.target.value)}
                                  onClick={(e) => e.stopPropagation()}
                                  onFocus={(e) => e.stopPropagation()}
                                  placeholder="Add custom prompt instructions for this item..."
                                  className="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none text-white placeholder-gray-500 text-sm resize-y min-h-[80px]"
                                  style={{ backgroundColor: 'rgba(255, 255, 255, 0.05)', borderColor: 'rgba(255, 255, 255, 0.1)' }}
                                />
                              </div>
                            )}
                          </div>
                        ))}
                      </div>
                    </div>
                  );
                })}
              </div>
            )}

            {/* Audit Report */}
            {auditReport && (
              <div className="space-y-6">
                <div className="flex items-center justify-between mb-6">
                  <h2 className="text-3xl font-bold">Audit Report</h2>
                  <div className="flex gap-3">
                    <button
                      onClick={exportToPDF}
                      className="px-4 py-2 bg-green-600 hover:bg-green-700 rounded-lg transition-colors flex items-center gap-2"
                    >
                      <Download className="w-4 h-4" />
                      Export PDF
                    </button>
                    <button
                      onClick={() => {
                        setAuditReport(null);
                        setScreenshot(null);
                        setElementScreenshots(null);
                        setUrl('');
                      }}
                      className="px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg transition-colors"
                    >
                      New Audit
                    </button>
                  </div>
                </div>

                {/* Screenshot Display */}
                {screenshot && (
                  <div className="rounded-xl p-6 border" style={{ backgroundColor: 'rgba(255, 255, 255, 0.05)', borderColor: 'rgba(255, 255, 255, 0.1)' }}>
                    <h3 className="text-xl font-bold mb-4">Website Screenshot</h3>
                    <div className="rounded-lg overflow-hidden border shadow-lg" style={{ borderColor: 'rgba(255, 255, 255, 0.1)' }}>
                      <img 
                        src={screenshot} 
                        alt="Website screenshot" 
                        className="w-full h-auto"
                        style={{ maxHeight: '600px', objectFit: 'contain' }}
                      />
                    </div>
                    <p className="text-sm text-gray-400 mt-2">Screenshot captured during audit</p>
                  </div>
                )}

                {auditReport.categories.map((category, catIndex) => (
                        <div key={catIndex} className="rounded-xl p-6 md:p-8 border" style={{ backgroundColor: 'rgba(255, 255, 255, 0.05)', borderColor: 'rgba(255, 255, 255, 0.1)' }}>
                    <h3 className="text-2xl font-bold mb-6 pb-4 border-b" style={{ borderColor: 'rgba(255, 255, 255, 0.1)' }}>
                      {category.title}
                    </h3>

                    <div className="space-y-6">
                      {category.items.map((item, itemIndex) => {
                        // Check if findings indicate "cannot verify"
                        const cannotVerify = item.findings && (
                          item.findings.toLowerCase().includes('cannot verify') ||
                          item.findings.toLowerCase().includes('cannot be verified') ||
                          item.findings.toLowerCase().includes('may be dynamically loaded') ||
                          item.findings.toLowerCase().includes('requires user interaction') ||
                          item.findings.toLowerCase().includes('not available in static html')
                        );
                        
                        // Determine actual status
                        const actualStatus = cannotVerify ? 'cannot_verify' : item.status;
                        
                        return (
                        <div key={itemIndex} className="border-l-4 pl-6 py-2" style={{
                          borderColor: getStatusBorderColor(actualStatus)
                        }}>
                          <div className="flex items-start gap-3 mb-3">
                            <CheckSquare className="w-5 h-5 text-blue-400 flex-shrink-0 mt-1" />
                            <div className="flex-1">
                              <h4 className="font-semibold text-lg mb-2">{item.label}</h4>
                              <span className={`inline-block px-3 py-1 rounded-full text-xs font-medium border ${getStatusColor(actualStatus)}`}>
                                {actualStatus === 'cannot_verify' ? 'CANNOT VERIFY' : actualStatus.toUpperCase()}
                              </span>
                            </div>
                          </div>

                          <div className="mt-4 space-y-4">
                            <div>
                              <p className="text-gray-300 leading-relaxed">{item.findings}</p>
                            </div>

                            {item.issues && item.issues.length > 0 && (
                              <div>
                                <p className="text-sm font-semibold text-red-400 mb-2">Issues Found:</p>
                                <ul className="list-disc list-inside space-y-1 text-gray-300">
                                  {item.issues.map((issue, i) => (
                                    <li key={i} className="text-sm leading-relaxed">{issue}</li>
                                  ))}
                                </ul>
                              </div>
                            )}

                            {item.recommendations && item.recommendations.length > 0 && (
                              <div>
                                <p className="text-sm font-semibold text-blue-400 mb-2">Recommendations:</p>
                                <ul className="list-disc list-inside space-y-1 text-gray-300">
                                  {item.recommendations.map((rec, i) => (
                                    <li key={i} className="text-sm leading-relaxed">{rec}</li>
                                  ))}
                                </ul>
                              </div>
                            )}

                            {/* Show relevant screenshot if AI requested one */}
                            {item.screenshotRequest && elementScreenshots && (
                              <div className="mt-4">
                                <p className="text-sm font-semibold text-purple-400 mb-2">Relevant Screenshot:</p>
                                <p className="text-xs text-gray-400 mb-2 italic">{item.screenshotRequest}</p>
                                {(() => {
                                  // Try to find matching screenshot based on request
                                  const requestLower = item.screenshotRequest.toLowerCase();
                                  let matchingScreenshot = null;
                                  
                                  // Check for form-related
                                  if (requestLower.includes('form')) {
                                    matchingScreenshot = elementScreenshots['form'] || elementScreenshots['[class*="form"]'];
                                  }
                                  // Check for button-related
                                  else if (requestLower.includes('button') || requestLower.includes('cta')) {
                                    matchingScreenshot = elementScreenshots['button'] || elementScreenshots['[class*="button"]'] || elementScreenshots['.cta'];
                                  }
                                  // Check for navigation
                                  else if (requestLower.includes('nav') || requestLower.includes('menu')) {
                                    matchingScreenshot = elementScreenshots['nav'];
                                  }
                                  // Check for header
                                  else if (requestLower.includes('header')) {
                                    matchingScreenshot = elementScreenshots['header'];
                                  }
                                  
                                  // If no match, show first available
                                  if (!matchingScreenshot && Object.keys(elementScreenshots).length > 0) {
                                    matchingScreenshot = Object.values(elementScreenshots)[0];
                                  }
                                  
                                  return matchingScreenshot ? (
                                    <div className="rounded-lg overflow-hidden border shadow-lg max-w-md" style={{ borderColor: 'rgba(255, 255, 255, 0.1)' }}>
                                      <img 
                                        src={matchingScreenshot} 
                                        alt={item.screenshotRequest}
                                        className="w-full h-auto"
                                        style={{ maxHeight: '300px', objectFit: 'contain' }}
                                      />
                                    </div>
                                  ) : null;
                                })()}
                              </div>
                            )}
                          </div>
                        </div>
                        );
                      })}
                    </div>
                  </div>
                ))}
              </div>
            )}
          </div>
          
          {/* Footer */}
          <footer className="text-center" style={{ paddingTop: '48px', paddingBottom: '48px' }}>
            <p className="text-white text-sm mb-2">Made by</p>
            <div className="flex justify-center items-center">
              <svg xmlns="http://www.w3.org/2000/svg" width="216" height="24" viewBox="0 0 216 24" fill="none">
                <g clipPath="url(#clip0_6433_9612)">
                  <path d="M19.6364 0.0429688L7.55204 5.82153L4.95802 7.06582L4.85257 7.10799L4.89475 7.00255L7.25679 1.56142H4.36751L0.00195312 11.6001L0.297208 12.2328L11.306 6.98146L14.8701 5.2732L14.9756 5.20993L14.9123 5.31538L8.98614 18.2644L8.94396 18.3488L8.90178 18.2644L6.22339 12.4015L3.81918 13.5403L8.60652 24.0008H9.4712L20.0371 0.928733L19.6364 0.0429688Z" fill="#F5F5F7"/>
                  <path d="M208.156 3.16473H206.574V2.57422H210.413V3.16473H208.831V7.40374H208.156V3.16473ZM213.007 7.42483L211.678 3.20691V7.42483H211.003V2.59531H212.142L213.386 6.62343L214.63 2.59531H215.769V7.42483H215.094V3.20691L213.766 7.42483H213.007Z" fill="#F5F5F7"/>
                  <path d="M24.444 7.57082C24.444 4.04885 28.1769 2.17188 31.5934 2.17188C35.3263 2.17188 38.321 3.83796 39.0592 7.86608H35.8535C35.3263 5.58839 33.2595 4.95571 31.5091 4.95571C30.0539 4.95571 27.8817 5.56731 27.8817 7.44428C27.8817 8.89947 29.1259 9.61651 30.6866 9.93286L32.9643 10.3547C36.2753 10.9663 39.502 12.2105 39.502 16.0489C39.502 19.8872 35.6637 21.8485 31.9309 21.8485C27.3755 21.8485 24.3597 19.3599 23.959 15.2053H27.2701C27.8817 17.7993 29.5477 19.149 32.1418 19.149C34.4194 19.149 36.191 18.1156 36.191 16.2387C36.191 14.2773 34.1242 13.6446 32.2472 13.3283L29.9695 12.9065C26.9326 12.3371 24.444 10.7764 24.444 7.57082Z" fill="#F5F5F7"/>
                  <path d="M45.0693 3.73242V7.46529H47.8742V9.74297H45.0693V17.4196C45.0693 18.8748 45.3856 19.1911 46.7354 19.1911H47.8742V21.5743H45.5965C42.5807 21.5743 41.9691 20.7518 41.9691 17.8414V9.63752H39.9023V7.46529H41.9691V3.73242H45.0693Z" fill="#F5F5F7"/>
                  <path d="M54.3913 21.8691C51.0802 21.8691 49.625 19.6968 49.625 16.2803V7.46484H52.7252V15.5422C52.7252 17.3981 53.0415 19.275 55.3192 19.275C57.7023 19.275 58.5248 17.4192 58.5248 14.9306V7.46484H61.625V21.5527H58.5248V19.5914C57.7023 21.0255 56.2682 21.8691 54.3913 21.8691Z" fill="#F5F5F7"/>
                  <path d="M77.0837 2.48828V21.4479H73.9835V19.6763C73.161 21.0261 71.7059 21.8486 69.8289 21.8486C66.5178 21.8486 63.7129 18.9382 63.7129 14.4883C63.7129 10.0384 66.5178 7.128 69.8289 7.128C71.6848 7.128 73.14 7.9505 73.9835 9.30023V2.48828H77.0837ZM66.9396 14.5094C66.9396 17.5252 68.3948 19.3811 70.4616 19.3811C72.5284 19.3811 74.089 17.8204 74.089 14.5094C74.089 11.3037 72.5284 9.63767 70.4616 9.63767C68.3948 9.63767 66.9396 11.4936 66.9396 14.5094Z" fill="#F5F5F7"/>
                  <path d="M83.1998 5.69393H80.0996V2.59375H83.1998V5.69393ZM83.1998 21.5533H80.0996V7.46546H83.1998V21.5533Z" fill="#F5F5F7"/>
                  <path d="M92.2256 21.869C88.8091 21.869 85.2871 19.5913 85.2871 14.5087C85.2871 9.42612 88.8091 7.14844 92.2256 7.14844C95.6421 7.14844 99.1641 9.42612 99.1641 14.5087C99.1641 19.5913 95.6421 21.869 92.2256 21.869ZM95.9585 14.5087C95.9585 11.3031 94.1869 9.63701 92.2256 9.63701C90.2643 9.63701 88.4927 11.1976 88.4927 14.5087C88.4927 17.7143 90.2643 19.3804 92.2256 19.3804C94.1869 19.275 95.9585 17.7143 95.9585 14.5087Z" fill="#F5F5F7"/>
                  <path d="M117.195 12.0208C117.195 19.4865 112.64 21.5533 106.629 21.5533H101.441V2.48828H106.629C112.64 2.48828 117.195 4.55506 117.195 12.0208ZM104.774 5.16666V18.8538H106.44C110.067 18.8538 113.8 18.0313 113.8 12.0208C113.8 6.01025 110.173 5.18775 106.44 5.18775L104.774 5.16666Z" fill="#F5F5F7"/>
                  <path d="M122.701 5.69393H119.58V2.59375H122.68V5.69393H122.701ZM122.701 21.5533H119.58V7.46546H122.68V21.5533H122.701Z" fill="#F5F5F7"/>
                  <path d="M131.917 10.4596C129.955 10.4596 128.817 11.282 128.817 14.087V21.4472H125.695V7.46482H128.795V9.9534C129.513 8.39277 130.862 7.46482 132.634 7.35938C132.845 7.35938 133.245 7.35938 133.456 7.46482V10.565C132.845 10.565 132.339 10.4596 131.917 10.4596Z" fill="#F5F5F7"/>
                  <path d="M140.522 19.275C142.188 19.275 143.432 18.6634 143.939 17.3136H147.039C146.427 19.5913 144.234 21.869 140.606 21.869C136.051 21.869 133.457 18.4525 133.457 14.4033C133.457 10.1643 136.367 7.14844 140.396 7.14844C144.74 7.14844 147.439 10.6704 147.123 15.4367H136.663C136.895 18.0307 138.772 19.275 140.522 19.275ZM144.044 13.0535C143.939 10.8813 142.272 9.53157 140.417 9.53157C138.961 9.53157 136.895 10.3541 136.684 13.0535H144.044Z" fill="#F5F5F7"/>
                  <path d="M158.658 12.231C158.341 10.7758 157.097 9.63699 155.347 9.63699C153.385 9.63699 151.614 11.0922 151.614 14.4032C151.614 17.7143 153.385 19.1695 155.241 19.1695C156.802 19.1695 158.341 18.4525 158.658 16.5755H161.674C161.062 19.8866 158.152 21.7635 155.136 21.7635C151.087 21.7635 148.303 18.5579 148.303 14.4032C148.303 10.2486 151.002 7.04297 155.241 7.04297C158.341 7.04297 161.041 9.0043 161.568 12.231H158.658Z" fill="#F5F5F7"/>
                  <path d="M167.263 3.73242V7.46529H170.068V9.74297H167.263V17.4196C167.263 18.8748 167.579 19.1911 168.929 19.1911H170.068V21.5743H167.79C164.774 21.5743 164.162 20.7518 164.162 17.8414V9.63752H162.096V7.46529H164.162V3.73242H167.263Z" fill="#F5F5F7"/>
                  <path d="M175.235 5.69393H172.135V2.59375H175.235V5.69393ZM175.235 21.5533H172.135V7.46546H175.235V21.5533Z" fill="#F5F5F7"/>
                  <path d="M184.155 21.869C180.739 21.869 177.217 19.5913 177.217 14.5087C177.217 9.42612 180.739 7.14844 184.155 7.14844C187.572 7.14844 191.094 9.42612 191.094 14.5087C191.199 19.5913 187.677 21.869 184.155 21.869ZM187.888 14.5087C187.888 11.3031 186.117 9.63701 184.155 9.63701C182.194 9.63701 180.422 11.1976 180.422 14.5087C180.422 17.7143 182.194 19.3804 184.155 19.3804C186.138 19.275 187.888 17.7143 187.888 14.5087Z" fill="#F5F5F7"/>
                  <path d="M200.647 7.14844C204.064 7.14844 205.414 9.32067 205.414 12.7372V21.5527H202.313V13.4753C202.313 11.6194 201.997 9.74246 199.614 9.74246C197.231 9.74246 196.303 11.5984 196.303 14.0869V21.5527H193.182V7.46478H196.282V9.42612C197.104 7.86548 198.665 7.14844 200.647 7.14844Z" fill="#F5F5F7"/>
                </g>
                <defs>
                  <clipPath id="clip0_6433_9612">
                    <rect width="216" height="24" fill="white"/>
                  </clipPath>
                </defs>
              </svg>
            </div>
          </footer>
        </div>
      );
    };

    // Render the app
    ReactDOM.render(<WebsiteAuditTool />, document.getElementById('root'));
  </script>
</body>
</html>
