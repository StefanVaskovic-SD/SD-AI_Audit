<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI Website Audit Tool</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState } = React;
    
    // Lucide Icons as React components
    const Search = ({ className }) => (
      <svg className={className} width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <circle cx="11" cy="11" r="8"></circle>
        <path d="m21 21-4.35-4.35"></path>
      </svg>
    );

    const CheckSquare = ({ className }) => (
      <svg className={className} width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <polyline points="9 11 12 14 22 4"></polyline>
        <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path>
      </svg>
    );

    const Square = ({ className }) => (
      <svg className={className} width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
      </svg>
    );

    const Loader2 = ({ className }) => (
      <svg className={className} width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <path d="M21 12a9 9 0 1 1-6.219-8.56"></path>
      </svg>
    );

    const AlertCircle = ({ className }) => (
      <svg className={className} width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <circle cx="12" cy="12" r="10"></circle>
        <line x1="12" y1="8" x2="12" y2="12"></line>
        <line x1="12" y1="16" x2="12.01" y2="16"></line>
      </svg>
    );

    const Download = ({ className }) => (
      <svg className={className} width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
        <polyline points="7 10 12 15 17 10"></polyline>
        <line x1="12" y1="15" x2="12" y2="3"></line>
      </svg>
    );

    const WebsiteAuditTool = () => {
      const [url, setUrl] = useState('');
      const [isAnalyzing, setIsAnalyzing] = useState(false);
      const [auditReport, setAuditReport] = useState(null);
      const [screenshot, setScreenshot] = useState(null);
      const [elementScreenshots, setElementScreenshots] = useState(null);
      const [error, setError] = useState('');
      const [selectedModel, setSelectedModel] = useState('gemini-2.0-flash');
      const [backendUrl, setBackendUrl] = useState('https://sd-ai-audit.onrender.com');

      // Define all audit categories and their checkboxes
      const [auditOptions, setAuditOptions] = useState({
        userJourneys: {
          title: 'Mapping of the existing user journeys',
          items: {
            criticalJourneys: {
              label: 'Identify the most critical user journeys (based on business goals and user frequency)',
              checked: true,
            },
            userTypes: {
              label: 'Consider different user types',
              checked: true,
            },
            painPoints: {
              label: 'Pain Points: Friction, confusion, unnecessary steps, dead ends',
              checked: true,
            },
            happyPath: {
              label: 'Map both happy path and alternative/edge case scenarios',
              checked: true,
            },
            dropOffRisks: {
              label: 'Drop-off Risks: Where users are likely to abandon the flow',
              checked: true,
            },
            cognitiveLoad: {
              label: 'Cognitive Load: Mental effort required at each step',
              checked: true,
            },
            errorHandling: {
              label: 'Error Handling: What happens when things go wrong',
              checked: true,
            },
            efficiency: {
              label: 'Efficiency: Time and effort required to complete tasks',
              checked: true,
            },
            userEmotions: {
              label: 'User emotions and frustrations at different stages',
              checked: true,
            },
            mobileVsDesktop: {
              label: 'Mobile vs. desktop experience differences',
              checked: true,
            },
          },
        },
        userExperience: {
          title: 'User Experience',
          items: {
            navigation: {
              label: 'Navigation & Information Architecture',
              checked: true,
            },
            ctaPlacement: {
              label: 'Call-to-action placement and clarity',
              checked: true,
            },
            hoverStates: {
              label: 'Hover states and interactive elements behaviour',
              checked: true,
            },
            interactions: {
              label: 'Interactions / animations assessment',
              checked: true,
            },
            touchTargets: {
              label: 'Touch target sizing for mobile users',
              checked: true,
            },
            conversionPaths: {
              label: 'Primary conversion paths (contact, purchase, signup)',
              checked: true,
            },
            trustElements: {
              label: 'Trust & Credibility Elements',
              checked: true,
            },
            loadingStates: {
              label: 'Loading states and progress indicators',
              checked: true,
            },
            filterSorting: {
              label: 'Filter and sorting patterns',
              checked: true,
            },
          },
        },
        contentAssessment: {
          title: 'Content Assessment',
          items: {
            messageClarity: {
              label: 'Message clarity and value proposition communication',
              checked: true,
            },
            contentRelevance: {
              label: 'Content relevance to target audience and user needs',
              checked: true,
            },
            writingQuality: {
              label: 'Writing quality, grammar, and professional tone',
              checked: true,
            },
            imageQuality: {
              label: 'Image quality, relevance, and professional appearance',
              checked: true,
            },
            engagingOpening: {
              label: 'Engaging opening that hooks the reader immediately',
              checked: true,
            },
            logicalProgression: {
              label: 'Logical content progression that guides users through a journey',
              checked: true,
            },
            sufficientDetail: {
              label: 'Sufficient detail to answer user questions and build confidence',
              checked: true,
            },
            clearNextSteps: {
              label: 'Clear next steps or guidance on what to do after reading',
              checked: true,
            },
            personalTouches: {
              label: 'Personal touches that build trust and connection',
              checked: true,
            },
          },
        },
        accessibility: {
          title: 'Accessibility',
          items: {
            textContrast: {
              label: 'Text contrast (WCAG AA: 4.5:1 for normal text, 3:1 for large text)',
              checked: true,
            },
            nonTextContrast: {
              label: 'Non-text contrast (WCAG 2.1: 3:1 for UI components)',
              checked: true,
            },
            placeholderText: {
              label: 'Placeholder text (must meet contrast ratio)',
              checked: true,
            },
            focusIndicator: {
              label: 'Focus indicator (visible and clear, 3:1 contrast)',
              checked: true,
            },
            targetSize: {
              label: 'Target size (clickable areas at least 24x24px)',
              checked: true,
            },
            hoverOnlyInfo: {
              label: 'No hover-only info (must appear on focus/keyboard/tap)',
              checked: true,
            },
            reflow: {
              label: 'Reflow (content reflows to 320px width without horizontal scrolling)',
              checked: true,
            },
            zoom: {
              label: 'Zoom (UI scales up to 200% without breaking)',
              checked: true,
            },
            spacing: {
              label: 'Spacing (line height, letter spacing allow overrides)',
              checked: true,
            },
            colorAlone: {
              label: "Don't rely on color alone (status indicators need icon/label)",
              checked: true,
            },
            links: {
              label: 'Links (distinguishable by underline, bold, etc.)',
              checked: true,
            },
            states: {
              label: 'States (hover, active, disabled, focus visually distinct)',
              checked: true,
            },
            labels: {
              label: 'Labels (all form fields have visible, persistent labels)',
              checked: true,
            },
            errorMessages: {
              label: 'Error messages (clear, high-contrast, near relevant input)',
              checked: true,
            },
            touchTargets: {
              label: 'Touch targets (enough spacing on mobile to avoid accidental taps)',
              checked: true,
            },
          },
        },
      });

      // Toggle individual checkbox
      const toggleCheckbox = (category, itemKey) => {
        setAuditOptions(prev => ({
          ...prev,
          [category]: {
            ...prev[category],
            items: {
              ...prev[category].items,
              [itemKey]: {
                ...prev[category].items[itemKey],
                checked: !prev[category].items[itemKey].checked,
              },
            },
          },
        }));
      };

      // Toggle all checkboxes in a category
      const toggleCategory = (category) => {
        const allChecked = Object.values(auditOptions[category].items).every(item => item.checked);
        const newCheckedState = !allChecked;

        setAuditOptions(prev => ({
          ...prev,
          [category]: {
            ...prev[category],
            items: Object.keys(prev[category].items).reduce((acc, key) => ({
              ...acc,
              [key]: {
                ...prev[category].items[key],
                checked: newCheckedState,
              },
            }), {}),
          },
        }));
      };

      // Generate AI prompt based on selected options
      const generateAuditPrompt = (websiteContent) => {
        let prompt = `You are an expert UX/UI auditor and web accessibility specialist. Analyze the following website and provide a comprehensive audit report.

WEBSITE CONTENT:
${websiteContent}

AUDIT INSTRUCTIONS:
Analyze ONLY the following checked items and provide detailed findings, issues, and recommendations for each.

`;

        Object.entries(auditOptions).forEach(([categoryKey, category]) => {
          const checkedItems = Object.entries(category.items)
            .filter(([_, item]) => item.checked);
          
          if (checkedItems.length > 0) {
            prompt += `\n## ${category.title.toUpperCase()}\n`;
            checkedItems.forEach(([itemKey, item]) => {
              prompt += `\nâœ“ ${item.label}\n`;
            });
          }
        });

        prompt += `\n\nFORMAT YOUR RESPONSE AS JSON:
{
  "categories": [
    {
      "title": "Category Name",
      "items": [
        {
          "label": "Item label",
          "status": "good" | "warning" | "critical",
          "findings": "Detailed description of what you found",
          "issues": ["List of specific issues if any"],
          "recommendations": ["List of specific recommendations"]
        }
      ]
    }
  ]
}

IMPORTANT: 
- Be specific and actionable in your recommendations
- Use "good" status for things done well, "warning" for minor issues, "critical" for serious problems
- Provide code examples or specific changes where relevant
- If you cannot assess something (like actual performance metrics), state that clearly
- Respond ONLY with valid JSON, no other text`;

        return prompt;
      };

      // Main analysis function
      const analyzeWebsite = async () => {
        if (!url) {
          setError('Please enter a website URL');
          return;
        }

        setIsAnalyzing(true);
        setError('');
        setAuditReport(null);
        setScreenshot(null);
        setElementScreenshots(null);

        try {
          console.log('Starting comprehensive audit...');
          console.log('URL:', url);
          console.log('Model:', selectedModel);
          console.log('Backend:', backendUrl);
          
          // Call backend API which handles website fetching and AI analysis
          const auditResponse = await fetch(`${backendUrl}/api/audit`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              url: url,
              auditOptions: auditOptions,
              model: selectedModel
            })
          });

          if (!auditResponse.ok) {
            // Clone response to read it multiple times if needed
            const errorResponse = auditResponse.clone();
            let errorData;
            try {
              errorData = await errorResponse.json();
            } catch (e) {
              try {
                const errorText = await auditResponse.text();
                errorData = { error: errorText };
              } catch (textError) {
                errorData = { error: `API request failed with status ${auditResponse.status}` };
              }
            }
            console.error('API Error:', errorData);
            throw new Error(errorData.error || `API request failed with status ${auditResponse.status}. Please check that the backend server is running.`);
          }

          const auditData = await auditResponse.json();
          
          // Handle response format: { success: true, report: {...} }
          let auditJson;
          if (auditData.report) {
            // New format - report is already parsed JSON object
            auditJson = auditData.report;
          } else if (auditData.content && auditData.content[0] && auditData.content[0].text) {
            // Old format - parse JSON from text
            let auditText = auditData.content[0].text;
            auditText = auditText.replace(/```json\s*/g, '').replace(/```\s*/g, '').trim();
            const jsonMatch = auditText.match(/\{[\s\S]*\}/);
            if (jsonMatch) {
              auditText = jsonMatch[0];
            }
            auditJson = JSON.parse(auditText);
          } else {
            throw new Error('Unexpected response format from server');
          }
          
          console.log('Parsed audit report:', auditJson);
          
          // Save screenshots if available
          if (auditData.screenshot) {
            setScreenshot(auditData.screenshot);
          } else {
            setScreenshot(null);
          }
          
          if (auditData.elementScreenshots) {
            setElementScreenshots(auditData.elementScreenshots);
          } else {
            setElementScreenshots(null);
          }
          
          // Validate the structure
          if (!auditJson.categories || !Array.isArray(auditJson.categories)) {
            throw new Error('Invalid audit report structure received');
          }
          
          setAuditReport(auditJson);

        } catch (err) {
          console.error('Analysis error:', err);
          let errorMessage = err.message;
          
          if (err.message.includes('JSON')) {
            errorMessage = 'Failed to parse audit report. The AI response was not in the expected format. Please try again.';
          } else if (err.message.includes('fetch') || err.message.includes('Failed to connect')) {
            errorMessage = 'Failed to connect to the backend server. Please make sure the backend is running on ' + backendUrl + '. Run "npm start" in the project directory.';
          } else if (err.message.includes('Failed to fetch website')) {
            errorMessage = 'Failed to fetch the website. Please check the URL and try again.';
          } else if (err.message.includes('504') || err.message.includes('Gateway Timeout') || err.message.includes('timeout')) {
            errorMessage = 'Request timed out. The analysis is taking too long. This might be due to a large website or slow response. Please try again or try a smaller website.';
          } else if (err.message.includes('body stream already read')) {
            errorMessage = 'Network error occurred. Please try again.';
          }
          
          setError(errorMessage);
        } finally {
          setIsAnalyzing(false);
        }
      };

      // Get status color
      const getStatusColor = (status) => {
        switch (status) {
          case 'good':
            return 'bg-green-100 text-green-800 border-green-300';
          case 'warning':
            return 'bg-yellow-100 text-yellow-800 border-yellow-300';
          case 'critical':
            return 'bg-red-100 text-red-800 border-red-300';
          case 'cannot_verify':
            return 'bg-gray-100 text-gray-800 border-gray-300';
          default:
            return 'bg-gray-100 text-gray-800 border-gray-300';
        }
      };

      // Get border color for status
      const getStatusBorderColor = (status) => {
        switch (status) {
          case 'good':
            return '#10b981'; // green
          case 'warning':
            return '#f59e0b'; // yellow
          case 'critical':
            return '#ef4444'; // red
          case 'cannot_verify':
            return '#6b7280'; // gray
          default:
            return '#6b7280'; // gray
        }
      };

      // Export audit report to PDF
      const exportToPDF = async () => {
        if (!auditReport) return;

        try {
          // Create a temporary container for PDF content
          const pdfContainer = document.createElement('div');
          pdfContainer.style.position = 'absolute';
          pdfContainer.style.left = '-9999px';
          pdfContainer.style.width = '210mm'; // A4 width
          pdfContainer.style.padding = '20mm';
          pdfContainer.style.backgroundColor = '#ffffff';
          pdfContainer.style.color = '#000000';
          pdfContainer.style.fontFamily = 'Arial, sans-serif';
          
          // Build PDF content
          let htmlContent = `
            <div style="margin-bottom: 30px;">
              <h1 style="font-size: 28px; font-weight: bold; margin-bottom: 10px; color: #1f2937;">AI Website Audit Report</h1>
              <p style="color: #6b7280; font-size: 14px;">Website: ${url}</p>
              <p style="color: #6b7280; font-size: 14px;">Generated: ${new Date().toLocaleString()}</p>
            </div>
          `;

          // Add screenshot to PDF if available
          if (screenshot) {
            htmlContent += `
              <div style="margin-bottom: 30px; page-break-inside: avoid;">
                <h2 style="font-size: 20px; font-weight: bold; margin-bottom: 15px; color: #1f2937;">Website Screenshot</h2>
                <div style="border: 1px solid #e5e7eb; border-radius: 8px; overflow: hidden; max-width: 100%;">
                  <img src="${screenshot}" alt="Website screenshot" style="width: 100%; height: auto; max-height: 400px; object-fit: contain; display: block;" />
                </div>
                <p style="color: #6b7280; font-size: 12px; margin-top: 8px;">Screenshot captured during audit</p>
              </div>
            `;
          }

          auditReport.categories.forEach((category, catIndex) => {
            htmlContent += `
              <div style="margin-bottom: 40px; page-break-inside: avoid;">
                <h2 style="font-size: 22px; font-weight: bold; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid #e5e7eb; color: #1f2937;">
                  ${category.title}
                </h2>
            `;

            category.items.forEach((item, itemIndex) => {
              // Check if findings indicate "cannot verify" for PDF
              const cannotVerify = item.findings && (
                item.findings.toLowerCase().includes('cannot verify') ||
                item.findings.toLowerCase().includes('cannot be verified') ||
                item.findings.toLowerCase().includes('may be dynamically loaded') ||
                item.findings.toLowerCase().includes('requires user interaction') ||
                item.findings.toLowerCase().includes('not available in static html')
              );
              
              // Determine actual status for PDF
              const actualStatus = cannotVerify ? 'cannot_verify' : item.status;
              const statusColor = actualStatus === 'good' ? '#10b981' : 
                                 actualStatus === 'warning' ? '#f59e0b' : 
                                 actualStatus === 'critical' ? '#ef4444' : '#6b7280';
              const statusText = actualStatus === 'cannot_verify' ? 'CANNOT VERIFY' : actualStatus.toUpperCase();

              htmlContent += `
                <div style="margin-bottom: 30px; padding-left: 15px; border-left: 4px solid ${statusColor}; page-break-inside: avoid;">
                  <div style="margin-bottom: 15px;">
                    <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 8px; color: #1f2937;">${item.label}</h3>
                    <span style="display: inline-block; padding: 4px 12px; border-radius: 12px; font-size: 11px; font-weight: 600; background-color: ${statusColor}20; color: ${statusColor}; border: 1px solid ${statusColor}40;">
                      ${statusText}
                    </span>
                  </div>
                  
                  <div style="margin-bottom: 15px;">
                    <p style="color: #374151; line-height: 1.6; font-size: 14px;">${item.findings}</p>
                  </div>
              `;

              if (item.issues && item.issues.length > 0) {
                htmlContent += `
                  <div style="margin-bottom: 15px;">
                    <p style="font-weight: 600; color: #ef4444; margin-bottom: 8px; font-size: 13px;">Issues Found:</p>
                    <ul style="margin-left: 20px; color: #374151; line-height: 1.8; font-size: 13px;">
                      ${item.issues.map(issue => `<li>${issue}</li>`).join('')}
                    </ul>
                  </div>
                `;
              }

              if (item.recommendations && item.recommendations.length > 0) {
                htmlContent += `
                  <div style="margin-bottom: 15px;">
                    <p style="font-weight: 600; color: #3b82f6; margin-bottom: 8px; font-size: 13px;">Recommendations:</p>
                    <ul style="margin-left: 20px; color: #374151; line-height: 1.8; font-size: 13px;">
                      ${item.recommendations.map(rec => `<li>${rec}</li>`).join('')}
                    </ul>
                  </div>
                `;
              }

              // Add screenshot to PDF if AI requested one
              if (item.screenshotRequest && elementScreenshots) {
                const requestLower = item.screenshotRequest.toLowerCase();
                let matchingScreenshot = null;
                
                if (requestLower.includes('form')) {
                  matchingScreenshot = elementScreenshots['form'] || elementScreenshots['[class*="form"]'];
                } else if (requestLower.includes('button') || requestLower.includes('cta')) {
                  matchingScreenshot = elementScreenshots['button'] || elementScreenshots['[class*="button"]'] || elementScreenshots['.cta'];
                } else if (requestLower.includes('nav') || requestLower.includes('menu')) {
                  matchingScreenshot = elementScreenshots['nav'];
                } else if (requestLower.includes('header')) {
                  matchingScreenshot = elementScreenshots['header'];
                }
                
                if (!matchingScreenshot && Object.keys(elementScreenshots).length > 0) {
                  matchingScreenshot = Object.values(elementScreenshots)[0];
                }
                
                if (matchingScreenshot) {
                  htmlContent += `
                    <div style="margin-bottom: 15px; margin-top: 15px;">
                      <p style="font-weight: 600; color: #9333ea; margin-bottom: 8px; font-size: 13px;">Relevant Screenshot:</p>
                      <p style="color: #6b7280; font-size: 11px; font-style: italic; margin-bottom: 8px;">${item.screenshotRequest}</p>
                      <div style="border: 1px solid #e5e7eb; border-radius: 8px; overflow: hidden; max-width: 400px;">
                        <img src="${matchingScreenshot}" alt="${item.screenshotRequest}" style="width: 100%; height: auto; max-height: 250px; object-fit: contain; display: block;" />
                      </div>
                    </div>
                  `;
                }
              }

              htmlContent += `</div>`;
            });

            htmlContent += `</div>`;
          });

          pdfContainer.innerHTML = htmlContent;
          document.body.appendChild(pdfContainer);

          // Use html2canvas to convert to image, then jsPDF to create PDF
          const canvas = await html2canvas(pdfContainer, {
            scale: 2,
            useCORS: true,
            logging: false,
            backgroundColor: '#ffffff'
          });

          const imgData = canvas.toDataURL('image/png');
          const { jsPDF } = window.jspdf;
          const pdf = new jsPDF('p', 'mm', 'a4');
          
          const imgWidth = 210; // A4 width in mm
          const pageHeight = 297; // A4 height in mm
          const imgHeight = (canvas.height * imgWidth) / canvas.width;
          let heightLeft = imgHeight;
          let position = 0;

          pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
          heightLeft -= pageHeight;

          while (heightLeft > 0) {
            position = heightLeft - imgHeight;
            pdf.addPage();
            pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
            heightLeft -= pageHeight;
          }

          // Generate filename
          const filename = `audit-report-${url.replace(/https?:\/\//, '').replace(/\//g, '-')}-${new Date().toISOString().split('T')[0]}.pdf`;
          pdf.save(filename);

          // Clean up
          document.body.removeChild(pdfContainer);
        } catch (error) {
          console.error('Error exporting PDF:', error);
          setError('Failed to export PDF. Please try again.');
        }
      };

      return (
        <div className="min-h-screen bg-gradient-to-br from-gray-900 via-gray-800 to-gray-900 text-white p-4 md:p-8">
          <div className="max-w-7xl mx-auto">
            {/* Header */}
            <div className="text-center mb-12">
              <h1 className="text-4xl md:text-5xl font-bold mb-4 bg-gradient-to-r from-blue-400 to-purple-400 bg-clip-text text-transparent">
                AI Website Audit Tool
              </h1>
              <p className="text-gray-400 text-lg">
                Comprehensive UX, Content, and Accessibility Analysis
              </p>
            </div>

            {/* URL Input Section */}
            <div className="bg-gray-800 rounded-2xl p-6 md:p-8 mb-8 shadow-2xl border border-gray-700">
              <div className="mb-4">
                <label className="block text-sm font-medium mb-2 text-gray-300">
                  Website URL
                </label>
                <input
                  type="url"
                  value={url}
                  onChange={(e) => setUrl(e.target.value)}
                  placeholder="https://example.com"
                  className="w-full px-4 py-3 bg-gray-900 border border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none text-white placeholder-gray-500"
                  disabled={isAnalyzing}
                />
              </div>
              
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                  <label className="block text-sm font-medium mb-2 text-gray-300">
                    AI Model
                  </label>
                  <select
                    value={selectedModel}
                    onChange={(e) => setSelectedModel(e.target.value)}
                    disabled={isAnalyzing}
                    className="w-full px-4 py-3 bg-gray-900 border border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none text-white"
                  >
                    <option value="gemini-2.0-flash">Gemini 2.0 Flash (Recommended)</option>
                    <option value="gemini-1.5-flash">Gemini 1.5 Flash</option>
                  </select>
                </div>
                <div>
                  <label className="block text-sm font-medium mb-2 text-gray-300">
                    Backend URL
                  </label>
                  <input
                    type="text"
                    value={backendUrl}
                    onChange={(e) => setBackendUrl(e.target.value)}
                    placeholder="https://sd-ai-audit.onrender.com"
                    className="w-full px-4 py-3 bg-gray-900 border border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none text-white placeholder-gray-500"
                    disabled={isAnalyzing}
                  />
                </div>
              </div>
              
              <button
                onClick={analyzeWebsite}
                disabled={isAnalyzing || !url}
                className="w-full px-8 py-3 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-600 disabled:cursor-not-allowed rounded-lg font-medium transition-colors flex items-center justify-center gap-2 shadow-lg"
              >
                {isAnalyzing ? (
                  <>
                    <Loader2 className="w-5 h-5 animate-spin" />
                    Analyzing with Gemini...
                  </>
                ) : (
                  <>
                    <Search className="w-5 h-5" />
                    Start Audit
                  </>
                )}
              </button>
              
              {error && (
                <div className="mt-4 p-4 bg-red-900/50 border border-red-500 rounded-lg flex items-start gap-3">
                  <AlertCircle className="w-5 h-5 text-red-400 flex-shrink-0 mt-0.5" />
                  <p className="text-red-200">{error}</p>
                </div>
              )}
            </div>

            {/* Audit Options - Only show when not analyzing and no report */}
            {!isAnalyzing && !auditReport && (
              <div className="space-y-6 mb-8">
                <h2 className="text-2xl font-bold mb-4">Select Audit Criteria</h2>
                <p className="text-gray-400 mb-6">
                  All items are checked by default. Uncheck any items you don't want to analyze.
                </p>

                {Object.entries(auditOptions).map(([categoryKey, category]) => {
                  const checkedCount = Object.values(category.items).filter(item => item.checked).length;
                  const totalCount = Object.values(category.items).length;
                  const allChecked = checkedCount === totalCount;

                  return (
                    <div key={categoryKey} className="bg-gray-800 rounded-xl p-6 border border-gray-700">
                      <div 
                        className="flex items-center gap-3 mb-4 cursor-pointer hover:bg-gray-700/50 p-2 rounded-lg transition-colors"
                        onClick={() => toggleCategory(categoryKey)}
                      >
                        {allChecked ? (
                          <CheckSquare className="w-6 h-6 text-blue-400 flex-shrink-0" />
                        ) : (
                          <Square className="w-6 h-6 text-gray-500 flex-shrink-0" />
                        )}
                        <div className="flex-1">
                          <h3 className="text-xl font-semibold">{category.title}</h3>
                          <p className="text-sm text-gray-400">{checkedCount} of {totalCount} selected</p>
                        </div>
                      </div>

                      <div className="space-y-3 pl-9">
                        {Object.entries(category.items).map(([itemKey, item]) => (
                          <div
                            key={itemKey}
                            className="flex items-start gap-3 cursor-pointer hover:bg-gray-700/30 p-2 rounded-lg transition-colors"
                            onClick={() => toggleCheckbox(categoryKey, itemKey)}
                          >
                            {item.checked ? (
                              <CheckSquare className="w-5 h-5 text-blue-400 flex-shrink-0 mt-0.5" />
                            ) : (
                              <Square className="w-5 h-5 text-gray-500 flex-shrink-0 mt-0.5" />
                            )}
                            <span className="text-gray-300 text-sm leading-relaxed">
                              {item.label}
                            </span>
                          </div>
                        ))}
                      </div>
                    </div>
                  );
                })}
              </div>
            )}

            {/* Audit Report */}
            {auditReport && (
              <div className="space-y-6">
                <div className="flex items-center justify-between mb-6">
                  <h2 className="text-3xl font-bold">Audit Report</h2>
                  <div className="flex gap-3">
                    <button
                      onClick={exportToPDF}
                      className="px-4 py-2 bg-green-600 hover:bg-green-700 rounded-lg transition-colors flex items-center gap-2"
                    >
                      <Download className="w-4 h-4" />
                      Export PDF
                    </button>
                    <button
                      onClick={() => {
                        setAuditReport(null);
                        setScreenshot(null);
                        setElementScreenshots(null);
                        setUrl('');
                      }}
                      className="px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg transition-colors"
                    >
                      New Audit
                    </button>
                  </div>
                </div>

                {/* Screenshot Display */}
                {screenshot && (
                  <div className="bg-gray-800 rounded-xl p-6 border border-gray-700">
                    <h3 className="text-xl font-bold mb-4">Website Screenshot</h3>
                    <div className="rounded-lg overflow-hidden border border-gray-600 shadow-lg">
                      <img 
                        src={screenshot} 
                        alt="Website screenshot" 
                        className="w-full h-auto"
                        style={{ maxHeight: '600px', objectFit: 'contain' }}
                      />
                    </div>
                    <p className="text-sm text-gray-400 mt-2">Screenshot captured during audit</p>
                  </div>
                )}

                {auditReport.categories.map((category, catIndex) => (
                  <div key={catIndex} className="bg-gray-800 rounded-xl p-6 md:p-8 border border-gray-700">
                    <h3 className="text-2xl font-bold mb-6 pb-4 border-b border-gray-700">
                      {category.title}
                    </h3>

                    <div className="space-y-6">
                      {category.items.map((item, itemIndex) => {
                        // Check if findings indicate "cannot verify"
                        const cannotVerify = item.findings && (
                          item.findings.toLowerCase().includes('cannot verify') ||
                          item.findings.toLowerCase().includes('cannot be verified') ||
                          item.findings.toLowerCase().includes('may be dynamically loaded') ||
                          item.findings.toLowerCase().includes('requires user interaction') ||
                          item.findings.toLowerCase().includes('not available in static html')
                        );
                        
                        // Determine actual status
                        const actualStatus = cannotVerify ? 'cannot_verify' : item.status;
                        
                        return (
                        <div key={itemIndex} className="border-l-4 pl-6 py-2" style={{
                          borderColor: getStatusBorderColor(actualStatus)
                        }}>
                          <div className="flex items-start gap-3 mb-3">
                            <CheckSquare className="w-5 h-5 text-blue-400 flex-shrink-0 mt-1" />
                            <div className="flex-1">
                              <h4 className="font-semibold text-lg mb-2">{item.label}</h4>
                              <span className={`inline-block px-3 py-1 rounded-full text-xs font-medium border ${getStatusColor(actualStatus)}`}>
                                {actualStatus === 'cannot_verify' ? 'CANNOT VERIFY' : actualStatus.toUpperCase()}
                              </span>
                            </div>
                          </div>

                          <div className="mt-4 space-y-4">
                            <div>
                              <p className="text-gray-300 leading-relaxed">{item.findings}</p>
                            </div>

                            {item.issues && item.issues.length > 0 && (
                              <div>
                                <p className="text-sm font-semibold text-red-400 mb-2">Issues Found:</p>
                                <ul className="list-disc list-inside space-y-1 text-gray-300">
                                  {item.issues.map((issue, i) => (
                                    <li key={i} className="text-sm leading-relaxed">{issue}</li>
                                  ))}
                                </ul>
                              </div>
                            )}

                            {item.recommendations && item.recommendations.length > 0 && (
                              <div>
                                <p className="text-sm font-semibold text-blue-400 mb-2">Recommendations:</p>
                                <ul className="list-disc list-inside space-y-1 text-gray-300">
                                  {item.recommendations.map((rec, i) => (
                                    <li key={i} className="text-sm leading-relaxed">{rec}</li>
                                  ))}
                                </ul>
                              </div>
                            )}

                            {/* Show relevant screenshot if AI requested one */}
                            {item.screenshotRequest && elementScreenshots && (
                              <div className="mt-4">
                                <p className="text-sm font-semibold text-purple-400 mb-2">Relevant Screenshot:</p>
                                <p className="text-xs text-gray-400 mb-2 italic">{item.screenshotRequest}</p>
                                {(() => {
                                  // Try to find matching screenshot based on request
                                  const requestLower = item.screenshotRequest.toLowerCase();
                                  let matchingScreenshot = null;
                                  
                                  // Check for form-related
                                  if (requestLower.includes('form')) {
                                    matchingScreenshot = elementScreenshots['form'] || elementScreenshots['[class*="form"]'];
                                  }
                                  // Check for button-related
                                  else if (requestLower.includes('button') || requestLower.includes('cta')) {
                                    matchingScreenshot = elementScreenshots['button'] || elementScreenshots['[class*="button"]'] || elementScreenshots['.cta'];
                                  }
                                  // Check for navigation
                                  else if (requestLower.includes('nav') || requestLower.includes('menu')) {
                                    matchingScreenshot = elementScreenshots['nav'];
                                  }
                                  // Check for header
                                  else if (requestLower.includes('header')) {
                                    matchingScreenshot = elementScreenshots['header'];
                                  }
                                  
                                  // If no match, show first available
                                  if (!matchingScreenshot && Object.keys(elementScreenshots).length > 0) {
                                    matchingScreenshot = Object.values(elementScreenshots)[0];
                                  }
                                  
                                  return matchingScreenshot ? (
                                    <div className="rounded-lg overflow-hidden border border-gray-600 shadow-lg max-w-md">
                                      <img 
                                        src={matchingScreenshot} 
                                        alt={item.screenshotRequest}
                                        className="w-full h-auto"
                                        style={{ maxHeight: '300px', objectFit: 'contain' }}
                                      />
                                    </div>
                                  ) : null;
                                })()}
                              </div>
                            )}
                          </div>
                        </div>
                        );
                      })}
                    </div>
                  </div>
                ))}
              </div>
            )}
          </div>
        </div>
      );
    };

    // Render the app
    ReactDOM.render(<WebsiteAuditTool />, document.getElementById('root'));
  </script>
</body>
</html>
